function logActivity(msg){const log=document.getElementById('log');const ts=new Date().toLocaleString();log.textContent=ts+" — "+msg+"\n"+log.textContent;}function readTransactionFromURL(){const params=new URLSearchParams(window.location.search);let t=params.get('data')||params.get('text')||params.get('t')||null;if(!t&&window.location.hash){t=decodeURIComponent(window.location.hash.slice(1));}return t;}function showTransactionText(text){document.getElementById('txnText').textContent=text||"— no transaction text found —";}function getStored(){try{return JSON.parse(localStorage.getItem('qr_transactions_v1'))||[];}catch{return[];}}function saveStored(arr){localStorage.setItem('qr_transactions_v1',JSON.stringify(arr));}function renderStored(){const list=document.getElementById('txList');const arr=getStored();list.innerHTML="";if(!arr.length){list.innerHTML=`<div class="muted">No transactions stored.</div>`;return;}arr.slice().reverse().forEach(tx=>{const div=document.createElement("div");div.className="tx-item";div.innerHTML=`<div><strong>${tx.text}</strong></div><div class="small">Saved: ${new Date(tx.savedAt).toLocaleString()}</div><div class="small">ID: ${tx.id}</div>`;list.appendChild(div);});}function storeTransaction(text){const arr=getStored();const entry={id:"tx_"+Date.now()+"_"+Math.floor(Math.random()*9000+1000),text,savedAt:new Date().toISOString()};arr.push(entry);saveStored(arr);renderStored();logActivity("Stored transaction "+entry.id);}document.addEventListener('DOMContentLoaded',()=>{const withdrawBtn=document.getElementById('withdrawBtn');const cancelBtn=document.getElementById('cancelBtn');const manualInput=document.getElementById('manualInput');const useInput=document.getElementById('useInput');const statusMsg=document.getElementById('statusMsg');const exportBtn=document.getElementById('exportBtn');const clearBtn=document.getElementById('clearBtn');let currentText=readTransactionFromURL();showTransactionText(currentText);if(currentText){statusMsg.textContent="Ready.";logActivity("Loaded transaction from URL.");}withdrawBtn.onclick=()=>{if(!currentText)return alert("No transaction text to withdraw.");storeTransaction(currentText);statusMsg.textContent="Transaction saved.";currentText="";showTransactionText("");};cancelBtn.onclick=()=>{statusMsg.textContent="Transaction canceled.";showTransactionText("");currentText="";logActivity("User canceled transaction.");};useInput.onclick=()=>{if(!manualInput.value.trim())return alert("Enter text first.");currentText=manualInput.value.trim();showTransactionText(currentText);statusMsg.textContent="Loaded from input.";};exportBtn.onclick=()=>{const blob=new Blob([JSON.stringify(getStored(),null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="transactions.json";a.click();URL.revokeObjectURL(url);};clearBtn.onclick=()=>{if(!confirm("Clear ALL stored transactions?"))return;localStorage.removeItem("qr_transactions_v1");renderStored();};renderStored();});